# -*- mode: Makefile; -*- 
#--------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation.  All rights reserved.
#--------------------------------------------------------------------------------
# 2007-08-23
#--------------------------------------------------------------------------------

TOP?=$(shell cd ..;pwd)

RELEASE=1
VER=$(shell cat $(TOP)/build/Makefile.versionnumber)
VMM_MAJOR=$(shell echo ${VER}|cut -f1 -d.)
VMM_MINOR=$(shell echo ${VER}|cut -f2 -d.)
VMM_PATCH=$(shell echo ${VER}|cut -f4 -d.)
VMM_BUILDNR=$(shell echo ${VER}|cut -f3 -d.)
VMM_VER=$(VMM_MAJOR).$(VMM_MINOR).$(VMM_PATCH).$(VMM_BUILDNR)

ECHO=@echo
MKPATH=mkdir -p
PF_WRITE=$(ECHO) $(1) > $(2)
PF_APPEND=$(ECHO) $(1) >> $(2)

#================================================================================
# Version information header file
#================================================================================

VERSION_PATH=$(TOP)/dev/src/include
VERSION_H=$(VERSION_PATH)/vmmbuildversion.h

vmmbuildversion.h : $(TOP)/build/Makefile.versionnumber
	-$(MKPATH) $(VERSION_PATH)
	@$(ECHO) "Creating $(VERSION_PATH)/$@" 
	@$(call PF_WRITE,"/*------------------------------------------------------------------------------",  $(VERSION_H))
	@$(call PF_APPEND,"    Copyright (C) 2007 Microsoft Corp.                                          ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"*/                                                                              ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"/**                                                                             ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"    \file                                                                       ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"    \brief       Auto generated file containing build version information       ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"    \author      Automated Build System                                         ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"    DO NOT EDIT THIS FILE!                                                      ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"    DO NOT CHECK IN THIS FILE!                                                  ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"*/                                                                              ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"/*----------------------------------------------------------------------------*/", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"#ifndef VMM_BUILDVERSION_H                                                      ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"#define VMM_BUILDVERSION_H                                                      ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"int const VMM_BUILDVERSION_MAJOR   = $(VMM_MAJOR);                              ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"int const VMM_BUILDVERSION_MINOR   = $(VMM_MINOR);                              ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"int const VMM_BUILDVERSION_PATCH   = $(VMM_PATCH);                              ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"int const VMM_BUILDVERSION_BUILDNR = $(VMM_BUILDNR);                            ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"                                                                                ", $(VERSION_PATH)/$@)
	@$(call PF_APPEND,"#endif // VMM_BUILDVERSION_H                                                    ", $(VERSION_PATH)/$@)
